function formatPrice(t,e){var r=(t.toFixed(product.priceFormat.decimal)+" ").replace(".",product.priceFormat.separator)+product.priceFormat.symbol;return void 0===e||e<=t?r:"<s>"+(e.toFixed(product.priceFormat.decimal)+" ").replace(".",product.priceFormat.separator)+product.priceFormat.symbol+'</s> <span class="specialPrice">'+r+"</span>"}function findExistingDeclinationsAndValues(t){var r=[];return t.forEach(function(t,e){Array.isArray(t)?r=r.concat(findExistingDeclinationsAndValues(t).map(function(t){return t.values.unshift(e),t})):""!==t&&r.push({id:t,values:[e]})}),r}function errorMsg(t,e){null!=t.data("timer")&&(window.clearTimeout(t.data("timer")),t.data("timer",null)),t.html(e).show(),t.data("timer",window.setTimeout(function(){t.fadeOut().data("timer",null)},2e3))}function cust(){product.error.cust&&delete product.error.cust;var t=$("#good_product_id");0<t.length&&""!=t.val()?(product.id=t.val(),product.multi=$("#cust_qty").val()):(product.id=null,product.multi=1,product.error.cust="cust"),$("body").triggerHandler("productChange")}function getPrice(t,e,r,i){var c={base_price:e.skus[t].price,unit_price:e.skus[t].price*i*e.multi,max_price:e.skus[t].maxPrice*i*e.multi,degre_price:e.skus[t].price};if(void 0!==e.skus[t].degressivite){var o,n=0,s=1,u=[];for(o in e.skus[t].degressivite.indexes)u[o]=1;u[0]=r*i;for(var p=0;p<e.multipliers.length;p++)0<e.multipliers[p].coef&&(u[e.multipliers[p].group]*=e.multipliers[p].qty*e.multipliers[p].coef);for(o in u){var a,d=null;for(a in e.skus[t].degressivite.indexes[o])u[o]>=e.skus[t].degressivite.indexes[o][a]&&(d=a);if(null===d){n=null;break}n+=d*s,s*=e.skus[t].degressivite.indexes[o].length}if(null===n)throw{error:"degre"};c.unit_price=e.skus[t].degressivite.prices[n]*i*e.multi,c.degre_price=e.skus[t].degressivite.prices[n]}return c.max_price=Math.round(100*c.max_price)/100,c.unit_price=Math.round(100*c.unit_price)/100,c}function refreshComponentPrice(c,t,o,n,s,u){var p=null==c?product:product.skus[c],a=0,d=0;return $.each(t,function(t,e){var r=p.components[t],i={id:t,componentObject:r,obj:p,skuid:c,selected:!r.infos.optional||r.selected&&0<r.qty,priceObject:null,unitPrice:0,totalPrice:0,qty_parent:o,product:{price:n,qty:s}};if(null!=r.id&&(i.priceObject=getPrice(r.id,r,o*r.qty*s,1)),i.$component=$("#component_"+t+(c?"_"+c:"")),i.$compo_self=i.$component.find(".compo_self").first(),0!==r.infos.qty){if(r.infos.price){if(r.infos.priceType)switch(r.infos.priceType){case"%self":i.unitPrice=r.infos.price*i.priceObject.unit_price;break;case"%product":i.unitPrice=r.infos.price*n}else i.unitPrice=r.infos.price;i.totalPrice=i.unitPrice*o*r.qty}i.$compo_self.find(".compo_unit_price").text(formatPrice(i.unitPrice)),i.$compo_self.find(".compo_total_price").text(formatPrice(i.totalPrice))}$("body").trigger("productChange:component",i);t=[];i.selected?(d=refreshComponentPrice(c,e,o*r.qty,n,s,t),!r.infos.deleteIfEmpty||0<t.length?(a+=r.qty*(i.unitPrice+d),$.isArray(u)&&u.push(i.id)):i.selected=!1):d=refreshComponentPrice(c,e,o*(0<r.qty?r.qty:1),n,s,t),i.unitChildrenPrice=d,i.selectedChildren=t,$("body").trigger("productChange:componentAfterChildren",i)}),a}function refreshPrices(){var e=!1;try{checkAll();var t=getPrice(product.id,product,product.qty,product.packaging)}catch(t){e=!0}if(e)$(".base_price").text(""),$(".unit_price").text(""),$(".reduc").hide(),$(".total_unit_price").text(""),$(".fix_add_price").text(""),$(".total_price").text(""),$(".ifOrderable").hide(),$(".ifNotOrderable").show(),$("body").triggerHandler("productRefreshError");else{$(".base_price").text(formatPrice(t.base_price)),$(".degre_price").text(formatPrice(t.degre_price)),$(".unit_price").text(formatPrice(t.unit_price)),t.max_price>t.unit_price?($(".reduc").show(),$(".max_price").text(formatPrice(t.max_price)),$(".reduc_price").text(formatPrice(t.max_price-t.unit_price)),$(".total_reduc_price").text(formatPrice((t.max_price-t.unit_price)*product.qty)),$(".reduc_percent").text((t.max_price-t.unit_price)/t.max_price*100)):$(".reduc").hide();var i=t.unit_price,c=0;product.componentsTree&&(i+=refreshComponentPrice(null,product.componentsTree,1,i,product.qty*product.packaging),product.id&&(i+=refreshComponentPrice(product.id,product.skus[product.id].componentsTree,1,i,product.qty*product.packaging))),$.each(product.fees,function(t,r){$.each(r.skus,function(t){var e;e=r.var?getPrice(t,r,product.qty,product.packaging):getPrice(t,r,1,1),$("#f_"+t).parent().find("span.pr").html(formatPrice(e.degre_price,r.skus[t].maxPrice)),r.id==t&&(r.var?i+=e.unit_price:c+=e.unit_price)})}),$.each(product.options,function(t,r){$.each(r.skus,function(t){var e;e=r.var?getPrice(t,r,product.qty,product.packaging):getPrice(t,r,1,1),$("#o_"+t).parent().find("span.pr").html(formatPrice(e.degre_price,r.skus[t].maxPrice)),r.selected&&r.id==t&&(r.var?i+=e.unit_price:c+=e.unit_price)})}),$.each(product.addcart,function(t,r){$.each(r.skus,function(t){var e=getPrice(t,r,r.qty,1);$("#a_"+t).parent().find("span.pr").html(formatPrice(e.degre_price,r.skus[t].maxPrice)),r.selected&&r.id==t&&(c+=e.unit_price*r.qty)})}),$(".total_unit_price").text(formatPrice(i)),$(".fix_add_price").text(formatPrice(c)),$(".total_price").text(formatPrice(i*product.qty+c));try{checkStock(),$(".ifOrderable").show(),$(".ifNotOrderable").hide(),$("body").triggerHandler("productRefreshOk")}catch(t){$(".ifOrderable").hide(),$(".ifNotOrderable").show(),$("body").triggerHandler("productRefreshStockError")}}}function refreshQuantity(){product.id&&(product.skus[product.id].qty_mini&&product.qty<product.skus[product.id].qty_mini?product.qty=product.skus[product.id].qty_mini:product.skus[product.id].qty_max&&product.qty>product.skus[product.id].qty_max&&(product.qty=product.skus[product.id].qty_max));var t=$("#quantity");0<t.length&&(parseInt(t.val(),10)!==product.qty&&t.val(product.qty),t.data("previous",product.qty))}function quantityChange(){var t=parseInt($(this).val(),10);!isNaN(t)&&0<t?product.qty=t:$(this).data("previous")&&(product.qty=$(this).data("previous")),$("body").triggerHandler("productChange")}function setMulti(t,e,r,i){if(t.multi=1,t.multipliers)for(var c=0;c<t.multipliers.length;c++)t.multipliers[c].id!=e||t.multipliers[c].lock||(t.multipliers[c].qty=r,"txt"==t.multipliers[c].type.substr(0,3)?t.multipliers[c].val=i:t.multipliers[c].val=r),null!==t.multi&&(""!==t.multipliers[c].qty&&null!==t.multipliers[c].qty?0<t.multipliers[c].coef&&t.multipliers[c].price_multi&&(t.multi*=t.multipliers[c].qty*t.multipliers[c].coef):t.multi=null)}function setMultis(r,i,c){setMulti(product,r,i,c),product.components&&$.each(product.components,function(t,e){setMulti(e,r,i,c)}),$.each(product.fees,function(t,e){setMulti(e,r,i,c)}),$.each(product.options,function(t,e){setMulti(e,r,i,c)}),$.each(product.addcart,function(t,e){setMulti(e,r,i,c)})}function multiplierChange(){var t,e=$(this).val(),r=$(this).data("type"),i=0,c=$(this).data("max"),o=$(this).data("min");"txt"==r.substr(0,3)?(i=((t="ws"==r.substr(-2))?e.replace(/\s+/g,""):e).length,o&&i<o?($(this).parents(".multi").find(".multi-error").text((t?product.text.min:product.text.minws)+" : "+o).show(),$(this).data("qty","")):c&&c<i?($(this).parents(".multi").find(".multi-error").text((t?product.text.max:product.text.maxws)+" : "+c).show(),$(this).data("qty","")):($(this).parents(".multi").find(".multi-error").text("").hide(),$(this).data("qty",i)),setMultis(this.id.substr("6"),$(this).data("qty"),e)):(i="int"==r?parseInt($(this).val(),10):parseFloat($(this).val().replace(",",".")),isNaN(i)||i<=0?$(this).data("previous")?$(this).val($(this).data("previous")):$(this).val($(this).data("default")):(c&&c<i&&(i=c,errorMsg($(this).parents(".multi").find(".multi-error"),product.text.max+" "+c)),o&&i<o&&(i=o,errorMsg($(this).parents(".multi").find(".multi-error"),product.text.min+" "+o)),$(this).val(i),$(this).data("previous",i)),setMultis(this.id.substr("6"),$(this).val(),null)),$("body").triggerHandler("productChange")}function check(t,e){if(null===t.id)throw e.error="decli",e;if(null===t.multi)throw e.error="multi",e}function checkAll(){if($.isEmptyObject(product.error)||$.each(product.error,function(t,e){throw{error:e}}),check(product,{}),product.qty<product.skus[product.id].qty_mini)throw{error:"qty_mini",val:product.skus[product.id].qty_mini};if(product.skus[product.id].qty_max&&product.qty>product.skus[product.id].qty_max)throw{error:"qty_max",val:product.skus[product.id].qty_max};$.each(product.fees,function(t,e){check(e,{id:t,type:"fees"})}),$.each(product.options,function(t,e){e.selected&&check(e,{id:t,type:"options"})}),$.each(product.addcart,function(t,e){e.selected&&check(e,{id:t,type:"addcart"})})}function checkStock(){if(!product.skus[product.id].hors_stock){if(product.skus[product.id].qty<=0)throw{error:"hors_stock"};if(product.skus[product.id].qty<product.skus[product.id].qty_mini)throw{error:"hors_stock_qty_mini"}}}function buy(t){t.preventDefault();var e=$(".buy-error");e.hide();try{checkAll(),checkStock()}catch(t){return void errorMsg(e,t.val?product.text[t.error].replace("%",t.val):product.text[t.error])}var r,e=$("#cust-form");void 0===product.cust||product.cust?(r=buyData(),0<e.length&&(r.cust={},e.find("select, input, textarea").filter('[name^="product_custom_val"]').each(function(){r.cust[this.id.substr(5)]=$(this).val()})),$("body").triggerHandler("productBeforeAddCart",r),null!=r.id&&addCart(r)):e.submit()}function buyMultiplierData(t){for(var e={},r=0;r<t.multipliers.length;r++)e[t.multipliers[r].id]=t.multipliers[r].val;return e}function buyData(){var i={id:product.id,qty:product.qty,multi:buyMultiplierData(product),packaging:product.packaging,products:[],opts:[],fees:[],compo:{},item_compo:{},fields:product.fields};function c(t,e){e.infos.optional&&e.selected&&(t.selected=!0),null==e.infos.qty&&0<e.qty&&(t.qty=e.qty),null!=e.id&&(t.id=e.id),e.multipliers&&(t.multi=buyMultiplierData(e))}return product.components&&($.each(product.components,function(t,e){var r={};c(r,e),$.isEmptyObject(r)||(i.compo[t]=r)}),$.each(product.skus[product.id].components,function(t,e){var r={};c(r,e),$.isEmptyObject(r)||(i.item_compo[t]=r)})),$.each(product.addcart,function(t,e){e.selected&&i.products.push({id:e.id,qty:e.qty,multi:buyMultiplierData(e)})}),$.each(product.options,function(t,e){e.selected&&i.opts.push({id:e.id,multi:buyMultiplierData(e)})}),$.each(product.fees,function(t,e){i.fees.push({id:e.id,multi:buyMultiplierData(e)})}),i}function optionChange(t){var e=$(this).attr("name").substr(2),r=$(this).prop("checked");r?(product[t.data.stack][e].id=this.id.substr(2),$(this).parents(".compl_opt").addClass("selected").find("div input").prop("disabled",!1)):$(this).parents(".compl_opt").removeClass("selected").find("div input").prop("disabled",!0),product[t.data.stack][e].selected=r,$("body").triggerHandler("productChange")}function packagingChange(){product.packaging=$(this).val(),$("body").triggerHandler("productChange")}function componentOrChangeHelper(t,e,r){for(var i in t.components[e].children)t.components[t.components[e].children[i]].selected=t.components[e].children[i]==r;$("body").triggerHandler("productChange")}function componentOrChange(){var t,e;$(this).prop("checked")&&(t=(e=$(this).closest(".component")).attr("id").split("_"),e=e.parent().closest(".component").attr("id").split("_")[1],componentOrChangeHelper(2<t.length?product.skus[t[2]]:product,e,t[1]))}function componentOptionalChange(){var t=$(this).closest(".component").attr("id").split("_");(2<t.length?product.skus[t[2]]:product).components[t[1]].selected=$(this).prop("checked"),$("body").triggerHandler("productChange")}function componentQtyChange(){var t=$(this).closest(".component").attr("id").split("_"),e=2<t.length?product.skus[t[2]]:product,r=parseInt($(this).val()),i=$(this).attr("min")?parseInt($(this).attr("min")):0;0!=i||e.components[t[1]].infos.optional||(i=1),(isNaN(r)||r<i)&&(r=i,$(this).val(r)),e.components[t[1]].qty=r,$("body").triggerHandler("productChange")}function componentRadioIDChange(){var t;$(this).prop("checked")&&((2<(t=$(this).closest(".component").attr("id").split("_")).length?product.skus[t[2]]:product).components[t[1]].id=$(this).val(),$("body").triggerHandler("productChange"))}$(function(){void 0!==product.cust&&$("#cust-form .field input, #cust-form .field select").change(function(){product.cust=!1}),product.error.cust&&$("#cust-form .field input, #cust-form .field select").change(function(){$("#custTarget").empty(),cust()}),$("#options.compl_opts").find("input.select_opt").on("change",{stack:"options"},optionChange),$("#addcart.compl_opts").find("input.select_opt").on("change",{stack:"addcart"},optionChange),$("#fees.compl_opts").find("input.select_opt").change(function(){var t=$(this).attr("name").substr(2);$(this).prop("checked")&&(product.fees[t].id=this.id.substr(2)),$("body").triggerHandler("productChange")}),$("#options, #addcart").find("input.trigger").change(function(){var t=$(this).parents(".compl_opt").find("input.select_opt"),e=t.filter(":checked");(e=0==e.length?t.eq(0):e).prop("checked",$(this).prop("checked")).triggerHandler("change")}),$("#options, #fees, #addcart").find(".compl_opt").each(function(){var t=$(this).find("input.trigger");(0<t.length?t:$(this).find("input.select_opt")).triggerHandler("change")}),$(".multiplier").change(multiplierChange).trigger("change"),$("#quantity").change(quantityChange).trigger("change"),$("#packaging").change(packagingChange).trigger("change");var t=$("#components");t.find(".compo_or").on("change",componentOrChange).trigger("change"),t.find(".compo_optional").on("change",componentOptionalChange).trigger("change"),t.find(".compo_qty").on("change",componentQtyChange).trigger("change"),t.find(".compo_radio_id").on("change",componentRadioIDChange).trigger("change"),$("body").trigger("productInit").on("productChange",function(){refreshQuantity(),refreshPrices()}).trigger("productChange"),$("#buy").click(buy),$("#js-stock-alert-popup").find(".close").on("click",function(t){$("#js-stock-alert-popup").jqmHide()}),$(".js-stock-alert-link").click(function(){$("#js-stock-alert-popup").addClass("jqmWindow").jqm({onHide:function(t){t.w.fadeOut(500),t.o.remove()}}).jqmShow()}),$(".js-stock-alert-form").on("submit",function(t){t.preventDefault();var e=$("#js-stock-alert-popup");e.removeClass("js-stock-alert-error js-stock-alert-result");t=$(this).serializeArray();t.push({name:"product-id",value:product.id}),$.ajax(this.attributes.action.value,{type:"POST",data:t,success:function(t){200==t.code?e.addClass("js-stock-alert-success js-stock-alert-result"):($(".js-stock-alert-msg-error").text(t.message),e.addClass("js-stock-alert-error js-stock-alert-result"))}})})});